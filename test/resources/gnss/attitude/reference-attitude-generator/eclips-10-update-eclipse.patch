--- eclips_Dec2017.f.orig	2018-09-21 17:50:36.415529470 +0200
+++ eclips_Dec2017.f	2018-09-21 17:50:58.947354695 +0200
@@ -117,6 +117,9 @@
 C                                    COMPUTING ORBITAL ANGULAR RATE (Luc Maisonobe)
 C                      Jul 10, 2018  ENSURE CONVERGENCE OF GLONASS YAWEND
 C                                    ITERATIVE COMPUTATION (Luc Maisonobe)
+C                      Jul 12, 2018  UPDATE ESTIMATED ECLIPSE START AND END TIME
+C                                    WHEN THEY ARE ESTIMATED FROM A CLOSER
+C                                    DATE THAN PREVIOUS ESTIME (Luc Maisonobe)
 C                      Sep 14, 2018  FIXED BODY-X UNIT VECTOR COMPUTATION
 C                                    EXACTLY AT NODE (AVOID NaNs), IMPROVE
 C                                    ITS ACCURACY FOR NON-PERFECTLY CIRCULAR
@@ -214,22 +217,22 @@
 C
 C     MAXSAT - MAXIMUM NUMBER OF SATELLITES, CHANGED IF REQUIRED
 C      
-      INTEGER MAXSAT
+      INTEGER MAXSAT, MAXECL
 C Jan 10, 2017
 C     PARAMETER (MAXSAT=64)
-      PARAMETER (MAXSAT=136)
+      PARAMETER (MAXSAT=136, MAXECL=10)
       REAL*8    BETAINI(*)
 C
       INTEGER*4 IDIR, IPRN
       INTEGER*4 IECLIPS, NECLIPS(*)
 C
-      REAL*8    TTAG, TWOHR, HALFHR
+      REAL*8    TTAG, HALFHR
       REAL*8    SVBCOS, PI
       REAL*8    ECLSTM(MAXSAT,*)
       REAL*8    ECLETM(MAXSAT,*)
       REAL*8    ANOON, ANIGHT
       REAL*8    CNOON, CNIGHT
-      REAL*8    DTR, DTTAG
+      REAL*8    DTR
       REAL*8    XSV(*), SANTXYZ(*), VSVC(*), BETA, MURATE, YANGLE, DET,
 C Jan 10, 2017
 C    &          YRATE(64), BETADG, PHI, SANTX,        v(3),r(3)
@@ -239,6 +242,8 @@
       REAL*8    YAWEND, LOFI(3), LOFIN, CPHI, SPHI
       REAL*8    SQRT, ACOS, ATAN, DCOS, COS, ATAN2, SIN, TAN
       REAL*8    DABS, ABS, SIGN, DMOD, MAX, MIN
+      REAL*8    SGAP(MAXSAT, MAXECL), EGAP(MAXSAT, MAXECL)
+      REAL*8    ECLCTM(MAXSAT,MAXECL)
 C Dec 12, 2013
       REAL*8 YBIAS
       INTEGER*4 IBLK(*), J, I
@@ -266,6 +271,7 @@
 C    &  ,.1140d0, 32*0.250d0, 36*0.203d0, 36*0.203d0/
 C BEIDOU RATES OF 0.085 & 0.158 ACCORDING TO DILSSNER (Nov 2017) 
      &  ,.1140d0, 32*0.250d0, 36*0.203d0, 10*0.085D0, 26*0.158d0/
+      SAVE SGAP, EGAP, ECLCTM
 C Jan 10, 2017
 C     GAL  BETAy => BETA0
 C     GAL  BETAx => ANOON=15DEG:  (ANIGHT-180); ANIGHT =180 + 15 DEG
@@ -336,7 +342,6 @@
 C Jan 10, 2017 -end
 C
       IECLIPS=0
-      TWOHR = 7200.D0
       HALFHR= 1800.D0
 C Jan 10, 2017 - no 1/2h extension for GALILEO
 C Dec 5, 2017  - as well as  INPRN (Beidou) SAT!
@@ -582,11 +587,9 @@
 C ONLY FORWARD
        IF (IDIR .GT. 0 ) THEN
 C
-C       INITIALIZE ECLIPSE START AND TIME TAG ARRAYS  
+C       INITIALIZE/UPDATE ECLIPSE START AND TIME TAG ARRAYS  
 C
         IF ( NECLIPS(IPRN) .EQ. 0 ) THEN
-        NECLIPS(IPRN)=NECLIPS(IPRN)+1
-          ECLSTM(IPRN,NECLIPS(IPRN))=TTAG+DET/MURATE
 C IIR MIDNIGHT/NOON TURN or II/IIA NOON TURN START
 C for IIR/GLONAS NIGHT (turn) only makes sense when |BETADG| < ANOON!
 C For IIA it gets here only when NOON is true and that happens only when |BETADG|< ANOON!
@@ -602,16 +605,14 @@
 C           IF(     IPRN .GT.32.AND.IPRN.LE.100) THEN
             IF(    (IPRN .GT.32.AND.IPRN.LE.100).OR.IPRN.EQ.INPRN) THEN
 C GLONASS NOON TURN MODE, ANOON ACORDING TO DILSSNER ET AL 2010 
-             ECLSTM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))-
-     &        ANOON/MURATE
-             ECLETM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))+
-     &        2.D0*ANOON/MURATE
+               CALL UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &              SGAP, EGAP, TTAG+DET/MURATE, ANOON/MURATE, TTAG)
             ELSE
 C GPS IIA/IIR/IIF NOON OR IIR MIDNIGHT TURNs
-             ECLSTM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))-
-     &        ABS(BETADG)*sqrt(ANOON/ABS(BETADG)-1.d0)/MURATE
-             ECLETM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))+
-     &        2*ABS(BETADG)*sqrt(ANOON/ABS(BETADG)-1.d0)/MURATE
+               CALL UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &              SGAP, EGAP, TTAG+DET/MURATE,
+     &              ABS(BETADG)*sqrt(ANOON/ABS(BETADG)-1.d0)/MURATE,
+     &              TTAG)
             ENDIF
           END IF
 C     II/IIA SHADOW START & END TIMES
@@ -622,12 +623,10 @@
 C    &         .OR.(IPRN .GT.64.AND.IPRN.LE.100)).AND.NIGHT) THEN
      &     .OR.(IPRN .GT.64.AND.IPRN.LE.100).OR.IPRN.EQ.INPRN)
      &     .AND.NIGHT) THEN
-           TMP = ACOS(MAX(-1.0D0, MIN(1.0D0,
-     &                -COS(ANIGHT*DTR) / COS(BETADG*DTR)))) / DTR
-           ECLSTM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))-
-     &      TMP/MURATE
-           ECLETM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))+
-     &      2.d0*TMP/MURATE
+             TMP = ACOS(MAX(-1.0D0, MIN(1.0D0,
+     &                  -COS(ANIGHT*DTR) / COS(BETADG*DTR)))) / DTR
+             CALL UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &            SGAP, EGAP, TTAG+DET/MURATE, TMP/MURATE, TTAG)
           END IF
       END IF
 C
@@ -636,10 +635,6 @@
 C
         IF( (NIGHT .AND. SVBCOS .LT. CNIGHT)
      &       .OR. (NOON .AND. SVBCOS .GT. CNOON) ) THEN
-          DTTAG= ABS(TTAG-ECLSTM(IPRN,NECLIPS(IPRN)))
-C
-C         ECLIPSE TIME IS MORE THAN 2 HOURS, THIS IS A NEW ECLIPSE!
-C
 C Feb 27, 2017
 C SET GPS, GLN, GAL BETAINI IF APPLICABLE, I.E. FWD & |BETA| =< 0.07 DEG
 C Dec 5, 2017
@@ -647,9 +642,6 @@
          IF(IDIR.GT.0.AND.(IPRN.LE.100.OR.IPRN.EQ.INPRN)
      &     .AND.ABS(BETADG).LE.0.07D0
      &     .AND.BETAINI(IPRN).EQ.0.D0) BETAINI(IPRN)= BETADG
-         IF( DTTAG .GT. TWOHR ) THEN
-          NECLIPS(IPRN)=NECLIPS(IPRN)+1
-            ECLSTM(IPRN,NECLIPS(IPRN))=TTAG+DET/MURATE
 C IIR MIDNIGHT/NOON TURN  or II/IIA NOON TURN START
 C                                  AND GLONASS NOON
             IF(IBLK(IPRN).GT.3.AND.IBLK(IPRN).LE.5.OR.NOON) THEN
@@ -662,16 +654,14 @@
 C            IF(IPRN.GT.32.AND.IPRN.LE.100) THEN
              IF((IPRN.GT.32.AND.IPRN.LE.100).OR.IPRN.EQ.INPRN) THEN
 C GLONASS NOON TURN MODE ACORDING TO DILSSNER ET AL 2010 
-              ECLSTM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))-
-     &          ANOON/MURATE
-              ECLETM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))+
-     &         2.D0*ANOON/MURATE
+               CALL UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &              SGAP, EGAP, TTAG+DET/MURATE, ANOON/MURATE, TTAG)
              ELSE
 C GPS TURNS ONLY
-              ECLSTM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))-
-     &         ABS(BETADG)*sqrt(ANOON/ABS(BETADG)-1.d0)/MURATE
-              ECLETM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))+
-     &         2.D0*ABS(BETADG)*sqrt(ANOON/ABS(BETADG)-1.d0)/MURATE
+               CALL UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &              SGAP, EGAP, TTAG+DET/MURATE,
+     &              ABS(BETADG)*sqrt(ANOON/ABS(BETADG)-1.d0)/MURATE,
+     &              TTAG)
 C May 03, 2017 -remove Jan 10 dead code below
 C Jan 10, 2017 - GALILEO NOON - start
 C             IF(IPRN .GT.64.AND.IPRN.LE.100)THEN
@@ -693,12 +683,9 @@
      &       .AND.NIGHT) THEN
              TMP = ACOS(MAX(-1.0D0, MIN(1.0D0,
      &                  -COS(ANIGHT*DTR) / COS(BETADG*DTR)))) / DTR
-             ECLSTM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))-
-     &       TMP/MURATE
-             ECLETM(IPRN,NECLIPS(IPRN))= ECLSTM(IPRN,NECLIPS(IPRN))+
-     &       2.d0*TMP/MURATE
+             CALL UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &            SGAP, EGAP, TTAG+DET/MURATE, TMP/MURATE, TTAG)
             END IF
-        END IF
         ENDIF
 C  END OF FORWARD (FWD) LOOP (IDIR = 1)
        ENDIF
@@ -728,7 +715,7 @@
               V(J)=VSVC(J)/SQRT(V2)
               R(J)=XSV(J)/SQRT(P2) 
              END DO
-C ORBIT ANGLE MU AT ECLIPSE/TURN START
+C ORBIT ANGLE MU AT ECLIPSE/TURN END
              DET= MURATE*(ECLETM(IPRN,I)-
      &                        ECLSTM(IPRN,I))/2.d0
 C Dec 12, 2013 - start
@@ -835,7 +822,7 @@
                IF((IPRN.GT.64.AND.IPRN.LE.100).OR.IPRN.EQ.INPRN) THEN
 C  SIN ORB ANGLE MU => YAWEND
                YAWEND=
-     &         SIN((ttag-(ECLSTM(IPRN,I)+ECLETM(IPRN,I))/2)*MURATE*DTR)
+     &         SIN((ttag-ECLCTM(IPRN,I))*MURATE*DTR)
 C Jan 10, 2017 - start
 C GAL ECLIPS MODEL: Shy => BETAE
              BETAE=0.5D0*(-SIGN(SIN(BETA0*DTR),BETADG)-SIN(BETADG*DTR))
@@ -917,7 +904,7 @@
                IF((IPRN.GT.64.AND.IPRN.LE.100).OR.IPRN.EQ.INPRN) THEN
 C  SIN ORB ANGLE MU => YAWEND
                YAWEND= SIN(
-     &         PI +(TTAG-(ECLSTM(IPRN,I)+ECLETM(IPRN,I))/2)*MURATE*DTR)
+     &         PI +(TTAG-ECLCTM(IPRN,I))*MURATE*DTR)
 C Jan 10, 2017
 C GAL ECLIPS MODEL: Shy => BETAE
              BETAE=0.5D0*(-SIGN(SIN(BETA0*DTR),BETADG)-SIN(BETADG*DTR))
@@ -958,5 +945,86 @@
       ENDIF
 1     CONTINUE
       RETURN
+      END
 C
+      SUBROUTINE UPDECL(IPRN, NECLIPS, ECLSTM, ECLETM, ECLCTM,
+     &                  SGAP, EGAP, ECLCTR, HALF, ESTTIM)
+C     NAME           UPDECL
+C
+C     PURPOSE        UPDATE ECLIPSE START/END/CENTER TIME ESTIMATES
+C                    IF THE NEW ESTIMATE IS MADE FROM AN ESTIMATION
+C                    TIME CLOSER TO THE ESTIMATED DATE THAN THE
+C                    PREVIOUS ESTIMATE
+C                    THIS ENSURES THAT THE ARRAYS ALWAYS HOLD THE
+C                    "BEST" ESTIMATES
+C
+C     PARAMETERS     DESCRIPTION
+C     IPRN           SV PRN NUMBER
+C     NECLIPS        NUMBER OF ECLIPSING FOR THE PRN SATELLITE 
+C     ECLSTM         ARRAY OF ECLIPSE START TIMES
+C     ECLETM         ARRAY OF ECLIPSE END TIMES
+C     ECLCTM         ARRAY OF ECLIPSE CENTER TIMES
+C     SGAP           ARRAY OF ESTIMATION GAPS FOR START TIMES
+C     EGAP           ARRAY OF ESTIMATION GAPS FOR END TIMES
+C     ECLCTR         ESTIMATED ECLIPSE CENTER TIME
+C     HALF           HALF TIME SPAN OF THE ECLIPSE
+C     ESTTIM         ESTIMATION TIME
+C
+      IMPLICIT NONE
+      INTEGER   MAXSAT, MAXECL
+      PARAMETER (MAXSAT=136, MAXECL=10)
+      LOGICAL   CHANGE
+      INTEGER*4 IPRN, NECLIPS(*)
+      REAL*8    ECLSTM(MAXSAT,*), SGAP(MAXSAT, MAXECL)
+      REAL*8    ECLETM(MAXSAT,*), EGAP(MAXSAT, MAXECL)
+      REAL*8    ECLCTM(MAXSAT,*)
+      REAL*8    ECLCTR, HALF, ESTTIM
+      REAL*8    ESTART, EEND, GSTART, GEND
+      REAL*8    ABS
+
+C     ESTIMATION GAP: DIFFERENCE BETWEEN ESTIMATED TIME AND ESTIMATION TIME
+      CHANGE = .FALSE.
+      ESTART = ECLCTR - HALF
+      EEND   = ECLCTR + HALF
+      GSTART = ABS(ESTART - ESTTIM)
+      GEND   = ABS(EEND   - ESTTIM)
+C
+      IF ((NECLIPS(IPRN) .EQ. 0)
+     &    .OR.
+     &    (ESTART .GT. ECLETM(IPRN, NECLIPS(IPRN)))) THEN
+C        THIS IS EITHER THE FIRST ECLIPS OR A NEW ECLIPS
+C        IN EITHER CASE, IT IS A FIRST ESTIMATE
+         NECLIPS(IPRN)               = NECLIPS(IPRN) + 1
+         ECLSTM(IPRN, NECLIPS(IPRN)) = ESTART
+         ECLETM(IPRN, NECLIPS(IPRN)) = EEND
+         ECLCTM(IPRN, NECLIPS(IPRN)) = ECLCTR
+         SGAP(IPRN, NECLIPS(IPRN))   = GSTART
+         EGAP(IPRN, NECLIPS(IPRN))   = GEND
+      ELSE
+C       IT IS A NEW ESTIMATE OF AN ALREADY KNOWN ECLIPS, WE CHECK THE ESTIMATES
+        IF (GSTART .LT. SGAP(IPRN, NECLIPS(IPRN))) THEN
+C          THE GAP IS SMALLER THAN THE PREVIOUS ONE
+C          THIS ESTIMATE IS THE CURRENT BETTER AND THE ONE WE SHOULD KEEP
+           ECLSTM(IPRN, NECLIPS(IPRN)) = ESTART
+           SGAP(IPRN, NECLIPS(IPRN))   = GSTART
+           CHANGE                      = .TRUE.
+        ENDIF
+C
+        IF (GEND .LT. EGAP(IPRN, NECLIPS(IPRN))) THEN
+C          THE GAP IS SMALLER THAN THE PREVIOUS ONE
+C          THIS ESTIMATE IS THE CURRENT BETTER AND THE ONE WE SHOULD KEEP
+           ECLETM(IPRN, NECLIPS(IPRN)) = EEND
+           EGAP(IPRN, NECLIPS(IPRN))   = GEND
+           CHANGE                      = .TRUE.
+        ENDIF
+C
+        IF (CHANGE) THEN
+C          EITHER THE START OR THE END DATE HAS CHANGED
+C          UPDATE THE CENTER DATE
+           ECLCTM(IPRN, NECLIPS(IPRN)) =
+     &          0.5D0 * (ECLSTM(IPRN, NECLIPS(IPRN))
+     &                 + ECLETM(IPRN, NECLIPS(IPRN)))
+        ENDIF
+      ENDIF
+      RETURN
       END
